# ZKFair L2 架构设计文档

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              用户界面层                                   │
├─────────────────────────────┬───────────────────────────────────────────┤
│         Web DApp            │           Mobile App (Future)              │
│    (React + TypeScript)     │                                           │
└─────────────────┬───────────┴───────────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────────────────────┐
│                           应用服务层                                      │
├─────────────────────────────┬───────────────────────────────────────────┤
│      Backend API            │              SDK                           │
│  (Node.js + Express)        │    (TypeScript + ethers.js)              │
└─────────────────┬───────────┴───────────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────────────────────┐
│                         ERC-4337 账户抽象层                              │
├──────────────┬──────────────┬──────────────┬────────────────────────────┤
│   Bundler    │  EntryPoint  │   Paymaster  │   Smart Wallets           │
│   Service    │   Contract   │   Contract   │   (Account Contracts)     │
└──────────────┴──────────────┴──────────────┴────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────────────────────┐
│                            L2 执行层                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                     Polygon CDK (Erigon Stack)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────────┐│
│  │  Sequencer  │  │   Executor  │  │ Aggregator  │  │  State DB      ││
│  └─────────────┘  └─────────────┘  └─────────────┘  └────────────────┘│
└─────────────────────────────────────────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────────────────────┐
│                         数据可用性层                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                            Celestia                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                    │
│  │ Light Node  │  │   Blob      │  │     DAS      │                    │
│  │             │  │  Submission │  │   Sampling   │                    │
│  └─────────────┘  └─────────────┘  └─────────────┘                    │
└─────────────────────────────────────────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────────────────────┐
│                          结算层 (L1)                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                         Ethereum Mainnet                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                    │
│  │ CDK L1      │  │  ZK Proof   │  │   Bridge    │                    │
│  │ Contracts   │  │ Verification│  │  Contracts  │                    │
│  └─────────────┘  └─────────────┘  └─────────────┘                    │
└─────────────────────────────────────────────────────────────────────────┘
```

## 核心组件详解

### 1. 用户界面层

#### Web DApp
- **技术栈**: React 18 + TypeScript + Tailwind CSS
- **钱包集成**: RainbowKit + Wagmi
- **主要功能**:
  - 智能钱包创建与管理
  - 稳定币转账（使用 USDC 支付 Gas）
  - 交易历史查询
  - 资产管理

### 2. 应用服务层

#### Backend API
- **框架**: Express.js + TypeScript
- **数据库**: PostgreSQL + Prisma ORM
- **缓存**: Redis
- **主要功能**:
  - 交易索引与查询
  - 统计数据聚合
  - 事件监听与推送
  - 健康检查与监控

#### SDK
- **语言**: TypeScript
- **依赖**: ethers.js v6 + @account-abstraction/sdk
- **功能**:
  - 智能钱包操作封装
  - UserOperation 构建
  - Gas 估算
  - 签名管理

### 3. ERC-4337 账户抽象层

#### Bundler Service
- **实现**: TypeScript + Express
- **内存池**: Redis
- **功能**:
  - UserOperation 收集
  - 批量提交
  - Gas 管理
  - 模拟验证

#### EntryPoint Contract
- **版本**: v0.6.0
- **部署**: 单例合约
- **功能**:
  - UserOperation 验证
  - 账户部署
  - 交易执行

#### Paymaster Contract
- **类型**: ERC20 Paymaster
- **支持代币**: USDC, USDT
- **集成**: Chainlink 价格预言机
- **功能**:
  - 代付 Gas 费用
  - 汇率计算
  - 余额管理

### 4. L2 执行层 (Polygon CDK)

#### Sequencer
- **功能**: 交易排序与批次生成
- **性能**: 1000+ TPS
- **批次间隔**: 2 秒

#### Executor
- **类型**: zkEVM
- **兼容性**: EVM 等效
- **操作码支持**: 99%+

#### Aggregator
- **功能**: ZK 证明生成
- **证明时间**: ~90 秒/批次
- **硬件要求**: 64GB RAM

### 5. 数据可用性层 (Celestia)

#### 集成方式
- **节点类型**: Light Node
- **提交方式**: Blob Submission
- **命名空间**: 独立命名空间

#### 成本优化
- **压缩**: zstd 压缩
- **批量**: 多交易打包
- **成本降低**: 95%+

### 6. 结算层 (Ethereum L1)

#### CDK L1 Contracts
- **PolygonZkEVM**: 主合约
- **PolygonZkEVMBridge**: 跨链桥
- **PolygonZkEVMGlobalExitRoot**: 全局退出根

## 数据流

### 交易流程 (使用稳定币支付 Gas)

```
1. 用户发起交易
   ↓
2. DApp 构建 UserOperation
   - 设置 target, data, value
   - 指定 Paymaster 地址
   - 添加 USDC 支付数据
   ↓
3. 用户签名 UserOperation
   ↓
4. 发送到 Bundler
   ↓
5. Bundler 验证
   - 调用 Paymaster.validatePaymasterUserOp
   - 检查 USDC 余额和授权
   - 模拟执行
   ↓
6. Bundler 打包多个 UserOps
   ↓
7. 提交到 EntryPoint
   ↓
8. EntryPoint 执行
   - 验证签名
   - 执行交易
   - Paymaster 收取 USDC
   - Paymaster 支付 ETH Gas
   ↓
9. CDK Sequencer 处理
   ↓
10. 批次数据发布到 Celestia
    ↓
11. ZK 证明生成
    ↓
12. 证明提交到 L1
```

### 数据可用性流程

```
1. Sequencer 生成批次
   ↓
2. 批次数据序列化
   ↓
3. 压缩 (zstd)
   ↓
4. 创建 Celestia Blob
   ↓
5. 提交到 Celestia
   - 获取 commitment
   - 记录 height
   ↓
6. DA 证明包含在 L2 状态
   ↓
7. L1 验证时检查 DA
```

## 安全模型

### 1. L2 安全性
- **假设**: 至少一个诚实的 Sequencer
- **验证**: ZK 证明确保状态转换正确
- **退出**: 强制退出机制

### 2. DA 安全性
- **Celestia 保证**: 数据可用性采样
- **轻节点验证**: DAS 确保数据可用
- **时间窗口**: 30 天数据保证

### 3. 账户安全
- **智能钱包**: 多签、社交恢复（可选）
- **Paymaster**: 限额、白名单
- **升级**: 时间锁、多签控制

## 性能指标

### L2 性能
- **TPS**: 1000-2000
- **区块时间**: 2 秒
- **最终性**: 10-20 分钟（L1 最终性）

### 成本
- **L2 Gas**: $0.01-0.05
- **DA 成本**: 降低 95%
- **稳定币 Gas**: 5% 溢价

### 可扩展性
- **水平扩展**: Sequencer 集群
- **垂直扩展**: 硬件升级
- **分片**: 未来路线图

## 监控与运维

### 关键指标
1. **L2 指标**
   - 区块高度
   - TPS
   - 内存池大小
   - Gas 价格

2. **Bundler 指标**
   - UserOp 处理速度
   - Bundle 成功率
   - Gas 消耗

3. **DA 指标**
   - Celestia 提交成功率
   - Blob 大小
   - 成本追踪

### 告警规则
- Sequencer 离线 > 1 分钟
- Bundler 失败率 > 10%
- Paymaster 余额 < 10 ETH
- Celestia 提交失败 > 3 次

## 升级路径

### 短期 (3-6 个月)
- [ ] 多 Paymaster 支持
- [ ] 批量交易优化
- [ ] 监控仪表板

### 中期 (6-12 个月)
- [ ] 去中心化 Sequencer
- [ ] 跨链消息传递
- [ ] 高级账户功能

### 长期 (12+ 个月)
- [ ] 完全去中心化
- [ ] 原生稳定币
- [ ] L3 支持