# ZKFair L2 管理面板文档

## 概述

ZKFair L2 管理面板是一个综合性的管理界面，供系统管理员监控、配置和控制 Layer 2 平台。它提供实时洞察、安全监控和操作控制功能。

## 功能特性

### 1. 仪表板
- **实时统计数据**：查看关键指标，包括总用户数、交易量、交易额和系统健康状况
- **活动图表**：交易量、用户增长和 Gas 使用趋势的可视化展示
- **最近活动动态**：监控最新交易和用户活动
- **系统健康指标**：CPU、内存、磁盘使用率和网络延迟监控

### 2. 用户管理
- **用户目录**：浏览和搜索所有平台用户
- **账户详情**：查看用户地址、智能钱包状态、交易历史
- **批量操作**：同时激活、暂停或管理多个用户
- **角色管理**：为可信用户分配管理员权限
- **导出功能**：下载用户数据用于报告

### 3. 智能钱包管理
- **钱包概览**：监控所有 ERC-4337 智能合约钱包
- **部署状态**：跟踪已部署与未部署的钱包
- **余额监控**：实时余额更新和刷新功能
- **交易历史**：查看钱包特定的交易记录
- **模块管理**：查看已安装的钱包模块和扩展

### 4. 交易监控
- **交易列表**：实时查看所有 UserOperations 和交易
- **高级筛选**：按状态、日期范围、地址等筛选
- **成功指标**：监控成功率和失败模式
- **Gas 分析**：按代币类型（USDC/USDT/原生代币）跟踪 Gas 消耗
- **导出报告**：生成 CSV 报告用于会计和分析

### 5. 分析仪表板
- **交易量指标**：跟踪总交易量及趋势分析
- **用户分析**：监控用户增长、留存和活动模式
- **Gas 使用分布**：可视化 Gas 支付代币偏好
- **性能指标**：平均打包时间、成功率和成本
- **热门操作**：识别最常见的交易类型
- **Gas 消耗大户**：监控高交易量用户

### 6. 安全中心
- **实时威胁检测**：监控认证失败、速率限制和可疑活动
- **安全事件**：跟踪和管理带有严重级别的安全事件
- **快速操作**：紧急暂停、密钥轮换、强制双因素认证、会话撤销
- **安全策略**：配置登录尝试次数、会话超时、IP 白名单
- **审计跟踪**：查看管理员操作和系统变更

### 7. 告警管理
- **告警规则**：创建基于阈值、异常和模式的告警
- **通知渠道**：配置邮件、短信、Slack 和 Webhook 通知
- **告警历史**：跟踪触发的告警和响应时间
- **规则管理**：启用/禁用规则，设置严重级别
- **渠道配置**：管理通知接收者和设置

### 8. 系统配置
- **Paymaster 设置**：配置每日限额、交易限额、白名单规则
- **Bundler 配置**：调整打包大小、间隔和 Gas 定价
- **Gas 设置**：管理汇率、加价百分比、自动充值
- **网络配置**：更新 RPC 端点、Celestia 节点、确认数
- **紧急控制**：关键情况下的系统级暂停功能

## 访问控制

### 认证
- 基于 Web3 签名的认证
- 带刷新功能的 JWT 令牌
- 可配置超时的会话管理

### 授权
- 基于角色的访问控制（RBAC）
- 所有管理面板访问需要管理员角色
- 特定操作的细粒度权限

## 技术架构

### 前端
- **框架**：React + TypeScript
- **UI 库**：Tailwind CSS + Heroicons
- **状态管理**：React hooks 和 context
- **图表**：Chart.js + react-chartjs-2
- **路由**：React Router v6

### 后端
- **API**：Express.js REST API
- **认证**：带刷新令牌的 JWT
- **数据库**：PostgreSQL + Prisma ORM
- **验证**：Zod 模式验证
- **安全**：Helmet、速率限制、CORS 保护

### 实时更新
- 实时数据的 WebSocket 连接
- 指标的自动刷新间隔
- 关键告警的推送通知

## 安全考虑

1. **认证安全**
   - 安全的 Web3 签名验证
   - 短期过期的 JWT 令牌
   - 刷新令牌轮换

2. **API 安全**
   - 基于用户和 IP 的速率限制
   - 请求验证和清理
   - HTTPS 强制执行

3. **数据保护**
   - 敏感数据加密
   - 所有管理员操作的审计日志
   - 定期安全扫描

4. **访问控制**
   - 最小权限原则
   - 定期权限审核
   - 多因素认证支持

## 最佳实践

1. **监控**
   - 定期审查安全事件
   - 告警阈值调整
   - 性能基线建立

2. **维护**
   - 定期备份验证
   - 系统更新计划
   - 配置变更文档

3. **事件响应**
   - 明确的升级程序
   - 紧急联系名单
   - 事后审查

## API 端点

### 仪表板
- `GET /api/admin/dashboard` - 获取仪表板统计数据

### 用户
- `GET /api/admin/users` - 分页列出用户
- `POST /api/admin/users/bulk-action` - 执行批量操作

### 智能钱包
- `GET /api/admin/smart-wallets` - 列出智能钱包
- `POST /api/admin/smart-wallets/:address/refresh` - 刷新钱包余额

### 交易
- `GET /api/admin/transactions` - 列出交易
- `GET /api/admin/transactions/stats` - 获取交易统计
- `POST /api/admin/transactions/export` - 导出交易

### 分析
- `GET /api/admin/analytics` - 获取分析数据

### 安全
- `GET /api/admin/security/events` - 列出安全事件
- `POST /api/admin/security/events/:id/resolve` - 解决安全事件

### 告警
- `GET /api/admin/alerts/rules` - 列出告警规则
- `GET /api/admin/alerts/channels` - 列出通知渠道
- `PATCH /api/admin/alerts/rules/:id` - 更新告警规则
- `DELETE /api/admin/alerts/rules/:id` - 删除告警规则

### 系统
- `GET /api/admin/system/config` - 获取系统配置
- `PUT /api/admin/system/config` - 更新系统配置
- `GET /api/admin/system/metrics` - 获取系统指标
- `POST /api/admin/system/emergency-pause` - 激活紧急暂停

## 部署

1. **环境变量**
   ```env
   ADMIN_JWT_SECRET=your-secret-key
   ADMIN_ALLOWED_ORIGINS=https://admin.zkfair.com
   ADMIN_SESSION_TIMEOUT=1800
   ```

2. **数据库设置**
   ```bash
   npx prisma migrate deploy
   npx prisma db seed
   ```

3. **初始管理员用户**
   ```bash
   npm run create-admin -- --address=0x...
   ```

4. **SSL 配置**
   - 为生产环境配置 HTTPS
   - 设置安全 cookie 标志
   - 启用 HSTS 头

## 故障排除

### 常见问题

1. **登录问题**
   - 验证钱包连接
   - 检查管理员角色分配
   - 清除浏览器缓存

2. **数据未更新**
   - 检查 WebSocket 连接
   - 验证 API 端点
   - 查看浏览器控制台

3. **性能问题**
   - 检查数据库索引
   - 审查查询优化
   - 监控服务器资源

### 支持

技术支持：
- 邮箱：admin-support@zkfair.com
- 文档：https://docs.zkfair.com/admin
- 紧急情况：使用紧急联系程序

## 功能详解

### 仪表板页面
仪表板提供平台的整体概览，包括：

1. **关键指标卡片**
   - 总用户数及增长率
   - 智能钱包数量（已部署/未部署）
   - 交易总量和成功率
   - 系统健康状态

2. **实时图表**
   - 7天交易量趋势图
   - 用户增长曲线
   - Gas 使用分布饼图
   - 系统性能指标

3. **最近活动**
   - 最新交易列表
   - 新用户注册
   - 重要系统事件

### 用户管理页面
提供全面的用户管理功能：

1. **用户列表**
   - 分页显示所有用户
   - 显示地址、角色、创建时间、最后活跃时间
   - 智能钱包关联状态

2. **搜索和筛选**
   - 按地址或钱包地址搜索
   - 按状态筛选（活跃/非活跃/暂停）
   - 批量选择功能

3. **批量操作**
   - 批量激活用户
   - 批量暂停用户
   - 批量删除（软删除）

### 智能钱包管理页面
专门管理 ERC-4337 智能钱包：

1. **钱包概览卡片**
   - 总钱包数
   - 已部署钱包数
   - 24小时活跃钱包
   - 锁定总价值

2. **钱包列表**
   - 钱包地址和所有者
   - 部署状态
   - 余额（可刷新）
   - 交易计数
   - 最后活动时间

3. **钱包详情模态框**
   - 完整地址信息
   - 部署交易哈希
   - Nonce 值
   - 已安装模块列表

### 交易监控页面
提供详细的交易分析：

1. **统计卡片**
   - 成功率百分比
   - 总交易量
   - 待处理交易数

2. **高级筛选器**
   - 按状态筛选
   - 日期范围选择
   - 地址筛选

3. **交易表格**
   - UserOp 哈希
   - 发送方/接收方
   - 交易值
   - Gas 成本和支付代币
   - 状态徽章

### 分析页面
深入的数据分析和可视化：

1. **时间范围选择**
   - 24小时、7天、30天、90天

2. **关键指标**
   - 总交易量及变化趋势
   - 用户总数及增长率
   - 交易数量
   - 平均 Gas 价格

3. **图表展示**
   - 交易量折线图
   - 用户增长柱状图
   - Gas 代币使用分布
   - 交易状态分布

4. **排行榜**
   - 热门操作类型
   - Gas 消耗大户

### 安全中心页面
全面的安全监控和管理：

1. **安全状态概览**
   - 失败认证次数
   - 速率限制触发
   - 被阻止的 IP
   - 活跃会话数

2. **安全事件列表**
   - 事件类型和严重级别
   - 详细描述
   - 来源信息
   - 影响用户数

3. **快速操作面板**
   - 紧急暂停按钮
   - 密钥轮换
   - 强制双因素认证
   - 撤销所有会话

4. **安全策略配置**
   - 最大登录尝试次数
   - 会话超时时间
   - IP 白名单状态
   - 2FA 要求级别

### 告警管理页面
智能告警系统配置：

1. **告警统计**
   - 总规则数
   - 活跃规则数
   - 24小时内触发次数
   - 通知渠道数

2. **通知渠道管理**
   - 邮件通知配置
   - 短信通知设置
   - Slack 集成
   - Webhook 配置

3. **告警规则表格**
   - 规则名称和描述
   - 触发条件
   - 严重级别
   - 通知渠道
   - 启用/禁用开关

4. **最近告警列表**
   - 触发的告警详情
   - 触发时间
   - 严重级别标签

### 系统配置页面
平台核心参数配置：

1. **系统指标监控**
   - CPU 使用率进度条
   - 内存使用率
   - 磁盘使用率
   - 网络延迟

2. **配置选项卡**
   - **Paymaster 设置**
     - 每日限额（USDC）
     - 单笔交易限额
     - 白名单启用状态
     - 紧急暂停状态
   
   - **Bundler 设置**
     - 最大打包大小
     - 打包间隔时间
     - 优先费用（Gwei）
     - 最大费用设置
   
   - **Gas 设置**
     - USDC/Gas 汇率
     - 加价百分比
     - 最小余额要求
     - 自动充值开关
   
   - **网络设置**
     - L2 RPC URL
     - Celestia 轻节点 URL
     - 区块确认数
     - 同步间隔

3. **操作按钮**
   - 保存更改
   - 紧急暂停（带确认）

这个管理面板为 ZKFair L2 平台提供了全面的管理和监控能力，确保系统的安全、稳定和高效运行。